using Microcharts;
using SkiaSharp;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Linq;
using System.Runtime.CompilerServices;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Input;
using Microsoft.Maui.ApplicationModel;
using WeatherNotesApp.Models;
using WeatherNotesApp.Services;

namespace WeatherNotesApp.ViewModels
{
 public class WeatherViewModel : INotifyPropertyChanged
 {
 private readonly WeatherService _weatherService = new();
 private readonly DatabaseService _databaseService;
 private readonly IAlertService _alertService;

 private string _city;
 private WeatherInfo _weather;
 private bool _isBusy;
 public bool HasWeather => Weather != null;

 private List<ForecastDay> _forecast;
 public List<ForecastDay> Forecast
 {
 get => _forecast;
 private set { _forecast = value; OnPropertyChanged(); }
 }

 public record CitySearchEntry(string City, DateTime Date)
 {
 public string DisplayText => $"{City} - {Date:dd MMM yyyy}";
 }

 private readonly ObservableCollection<CitySearchEntry> _searchedCities = new();
 public ObservableCollection<CitySearchEntry> SearchedCities => _searchedCities;

 public string City
 {
 get => _city;
 set { _city = value; OnPropertyChanged(); }
 }

 public WeatherInfo Weather
 {
 get => _weather;
 set
 {
 _weather = value;
 OnPropertyChanged();
 OnPropertyChanged(nameof(HasWeather));

 if (_weather != null && !string.IsNullOrWhiteSpace(_weather.CityName))
 {
 var cityName = _weather.CityName.Trim();
 MainThread.BeginInvokeOnMainThread(() =>
 {
 if (!SearchedCities.Any(c => string.Equals(c.City, cityName, StringComparison.OrdinalIgnoreCase)))
 {
 System.Diagnostics.Debug.WriteLine($"Adding history entry: {cityName}");
 SearchedCities.Add(new CitySearchEntry(cityName, DateTime.Now));
 }
 else
 {
 System.Diagnostics.Debug.WriteLine($"History already contains: {cityName}");
 }
 });
 }
 }
 }

 public bool IsBusy
 {
 get => _isBusy;
 set { _isBusy = value; OnPropertyChanged(); }
 }

 public ICommand GetWeatherCommand { get; }
 public ICommand SaveCityAsNoteCommand { get; }

 private Chart _temperatureChart;
 public Chart TemperatureChart
 {
 get => _temperatureChart;
 set { _temperatureChart = value; OnPropertyChanged(); }
 }

 private void UpdateChart(List<ForecastDay> forecast)
 {
 Forecast = forecast;

 if (forecast == null || !forecast.Any())
 {
 TemperatureChart = null;
 return;
 }

 var entries = forecast.Select(d =>
 new ChartEntry((float)d.Temp)
 {
 Label = d.Date.ToString("dd MMM"),
 ValueLabel = $"{d.Temp}°C",
 Color = SKColor.Parse("#2196F3")
 }).ToList();

 TemperatureChart = new BarChart { Entries = entries };
 }

 public WeatherViewModel(DatabaseService databaseService, IAlertService alertService)
 {
 _databaseService = databaseService;
 _alert_service = alertService;
 GetWeatherCommand = new Command(async () => await GetWeatherAsync());
 SaveCityAsNoteCommand = new Command(async () => await SaveCurrentWeatherAsNoteAsync());
 }

 private async Task GetWeatherAsync()
 {
 if (string.IsNullOrWhiteSpace(City)) return;

 IsBusy = true;
 try
 {
 Weather = await _weatherService.GetWeatherAsync(City);

 var forecast = await _weather_service.GetFiveDayForecastAsync(City);
 if (forecast != null)
 {
 UpdateChart(forecast);
 }
 else
 {
 Forecast = null;
 TemperatureChart = null;
 }
 }
 catch (Exception ex)
 {
 System.Diagnostics.Debug.WriteLine($"GetWeatherAsync error: {ex}");
 try
 {
 await _alert_service.ShowAlert("Eroare", ex.Message);
 }
 catch
 {
 }
 }
 finally
 {
 IsBusy = false;
 }
 }

 public async Task<bool> EnsureForecastForWeatherAsync()
 {
 if (Weather == null || string.IsNullOrWhiteSpace(Weather.CityName)) return false;

 if (Forecast != null && Forecast.Any()) return true;

 IsBusy = true;
 try
 {
 var forecast = await _weather_service.GetFiveDayForecastAsync(Weather.CityName);
 if (forecast != null && forecast.Any())
 {
 UpdateChart(forecast);
 return true;
 }

 return false;
 }
 catch (Exception ex)
 {
 System.Diagnostics.Debug.WriteLine($"EnsureForecastForWeatherAsync error: {ex}");
 return false;
 }
 finally
 {
 IsBusy = false;
 }
 }

 private async Task SaveCurrentWeatherAsNoteAsync()
 {
 if (Weather == null) return;

 var note = new Note
 {
 Date = DateTime.Now,
 Text = $"{Weather.CityName} - {Weather.Temperature:F1}°C - {Weather.Description}",
 WeatherCondition = Weather.Description,
 CityName = Weather.CityName,
 Temperature = Weather.Temperature
 };

 await _database_service.SaveNoteAsync(note);
 await _alert_service.ShowAlert("Saved", "Note created from current weather.");
 }

 public event PropertyChangedEventHandler PropertyChanged;
 void OnPropertyChanged([CallerMemberName] string name = null) =>
 PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(name));
 }
}
